"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const atom_1 = require("atom");
const CP = require("child_process");
let subs;
exports.config = {
    command: {
        type: 'string',
        default: 'cat',
    },
    runOnSave: {
        type: 'boolean',
        default: false,
    },
    replaceText: {
        type: 'boolean',
        default: false,
    },
};
function activate() {
    subs = new atom_1.CompositeDisposable();
    subs.add(atom.commands.add('atom-text-editor', {
        'unix-filter:run': ({ currentTarget }) => {
            run(currentTarget.getModel()).catch((e) => {
                console.error(e);
            });
        },
        'unix-filter:exec': async ({ currentTarget }) => {
            const textEditorElement = document.createElement('atom-text-editor');
            textEditorElement.setAttribute('mini', '');
            const panel = atom.workspace.addModalPanel({
                item: textEditorElement,
                visible: true,
            });
            textEditorElement.focus();
            const disp = new atom_1.CompositeDisposable();
            const cont = await new Promise((resolve) => {
                disp.add(atom.commands.add(textEditorElement, {
                    'core:confirm': () => resolve(true),
                    'core:cancel': () => resolve(false),
                }));
            });
            disp.dispose();
            panel.destroy();
            if (cont) {
                const cmd = textEditorElement.getModel().getText();
                customCommand(currentTarget.getModel(), cmd).catch((e) => {
                    console.error(e);
                });
            }
        },
    }), atom.workspace.observeTextEditors((editor) => {
        const buf = editor.getBuffer();
        const disp = new atom_1.CompositeDisposable();
        disp.add(buf.onWillSave(async () => {
            const shouldRun = atom.config.get('unix-filter.runOnSave', {
                scope: editor.getRootScopeDescriptor(),
            });
            if (shouldRun)
                await run(editor);
        }), buf.onDidDestroy(() => {
            subs.remove(disp);
            disp.dispose();
        }));
        subs.add(disp);
    }));
}
exports.activate = activate;
function deactivate() {
    subs.dispose();
}
exports.deactivate = deactivate;
async function run(editor) {
    const cmd = atom.config.get('unix-filter.command', {
        scope: editor.getRootScopeDescriptor(),
    });
    return customCommand(editor, cmd);
}
async function customCommand(editor, cmd) {
    const text = editor.getText();
    return new Promise((resolve) => {
        const newEnv = Object.assign({}, process.env);
        newEnv.FILE = editor.getPath();
        const proc = CP.exec(cmd, { encoding: 'utf8', env: newEnv }, (error, result) => {
            if (error) {
                atom.notifications.addError(error.toString(), {
                    detail: error.message,
                    stack: error.stack,
                    dismissable: true,
                });
                resolve();
            }
            else {
                const [first, ...points] = editor
                    .getCursors()
                    .map((c) => c.getBufferPosition());
                const replaceText = atom.config.get('unix-filter.replaceText', {
                    scope: editor.getRootScopeDescriptor(),
                });
                if (replaceText) {
                    editor.setText(result.replace(/^ +$/gm, ''));
                    editor.setCursorBufferPosition(first);
                    points.forEach((p) => editor.addCursorAtBufferPosition(p));
                }
                resolve();
            }
        });
        proc.stdin.write(text);
        proc.stdin.end();
    });
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWFpbi5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy9tYWluLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsK0JBQXNEO0FBQ3RELG9DQUFtQztBQUVuQyxJQUFJLElBQXlCLENBQUE7QUFFaEIsUUFBQSxNQUFNLEdBQUc7SUFDcEIsT0FBTyxFQUFFO1FBQ1AsSUFBSSxFQUFFLFFBQVE7UUFDZCxPQUFPLEVBQUUsS0FBSztLQUNmO0lBQ0QsU0FBUyxFQUFFO1FBQ1QsSUFBSSxFQUFFLFNBQVM7UUFDZixPQUFPLEVBQUUsS0FBSztLQUNmO0lBQ0QsV0FBVyxFQUFFO1FBQ1gsSUFBSSxFQUFFLFNBQVM7UUFDZixPQUFPLEVBQUUsS0FBSztLQUNmO0NBQ0YsQ0FBQTtBQUVEO0lBQ0UsSUFBSSxHQUFHLElBQUksMEJBQW1CLEVBQUUsQ0FBQTtJQUNoQyxJQUFJLENBQUMsR0FBRyxDQUNOLElBQUksQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLGtCQUFrQixFQUFFO1FBQ3BDLGlCQUFpQixFQUFFLENBQUMsRUFBRSxhQUFhLEVBQUUsRUFBRSxFQUFFO1lBQ3ZDLEdBQUcsQ0FBQyxhQUFhLENBQUMsUUFBUSxFQUFFLENBQUMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLEVBQUUsRUFBRTtnQkFDeEMsT0FBTyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQTtZQUNsQixDQUFDLENBQUMsQ0FBQTtRQUNKLENBQUM7UUFFRCxrQkFBa0IsRUFBRSxLQUFLLEVBQUUsRUFBRSxhQUFhLEVBQUUsRUFBRSxFQUFFO1lBQzlDLE1BQU0saUJBQWlCLEdBQUcsUUFBUSxDQUFDLGFBQWEsQ0FBQyxrQkFBa0IsQ0FBQyxDQUFBO1lBQ3BFLGlCQUFpQixDQUFDLFlBQVksQ0FBQyxNQUFNLEVBQUUsRUFBRSxDQUFDLENBQUE7WUFDMUMsTUFBTSxLQUFLLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxhQUFhLENBQUM7Z0JBQ3pDLElBQUksRUFBRSxp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QTthQUNWO1FBQ0gsQ0FBQyxDQUFDLENBQUE7UUFDRixJQUFJLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsQ0FBQTtRQUN0QixJQUFJLENBQUMsS0FBSyxDQUFDLEdBQUcsRUFBRSxDQUFBO0lBQ2xCLENBQUMsQ0FBQyxDQUFBO0FBQ0osQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IENvbXBvc2l0ZURpc3Bvc2FibGUsIFRleHRFZGl0b3IgfSBmcm9tICdhdG9tJ1xyXG5pbXBvcnQgKiBhcyBDUCBmcm9tICdjaGlsZF9wcm9jZXNzJ1xyXG5cclxubGV0IHN1YnM6IENvbXBvc2l0ZURpc3Bvc2FibGVcclxuXHJcbmV4cG9ydCBjb25zdCBjb25maWcgPSB7XHJcbiAgY29tbWFuZDoge1xyXG4gICAgdHlwZTogJ3N0cmluZycsXHJcbiAgICBkZWZhdWx0OiAnY2F0JyxcclxuICB9LFxyXG4gIHJ1bk9uU2F2ZToge1xyXG4gICAgdHlwZTogJ2Jvb2xlYW4nLFxyXG4gICAgZGVmYXVsdDogZmFsc2UsXHJcbiAgfSxcclxuICByZXBsYWNlVGV4dDoge1xyXG4gICAgdHlwZTogJ2Jvb2xlYW4nLFxyXG4gICAgZGVmYXVsdDogZmFsc2UsXHJcbiAgfSxcclxufVxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIGFjdGl2YXRlKCkge1xyXG4gIHN1YnMgPSBuZXcgQ29tcG9zaXRlRGlzcG9zYWJsZSgpXHJcbiAgc3Vicy5hZGQoXHJcbiAgICBhdG9tLmNvbW1hbmRzLmFkZCgnYXRvbS10ZXh0LWVkaXRvcicsIHtcclxuICAgICAgJ3VuaXgtZmlsdGVyOnJ1bic6ICh7IGN1cnJlbnRUYXJnZXQgfSkgPT4ge1xyXG4gICAgICAgIHJ1bihjdXJyZW50VGFyZ2V0LmdldE1vZGVsKCkpLmNhdGNoKChlKSA9PiB7XHJcbiAgICAgICAgICBjb25zb2xlLmVycm9yKGUpXHJcbiAgICAgICAgfSlcclxuICAgICAgfSxcclxuICAgICAgLy8gVE9ETzogYXRvbS1zZWxlY3QtbGlzdCB3aXRoIGhpc3RvcnlcclxuICAgICAgJ3VuaXgtZmlsdGVyOmV4ZWMnOiBhc3luYyAoeyBjdXJyZW50VGFyZ2V0IH0pID0+IHtcclxuICAgICAgICBjb25zdCB0ZXh0RWRpdG9yRWxlbWVudCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2F0b20tdGV4dC1lZGl0b3InKVxyXG4gICAgICAgIHRleHRFZGl0b3JFbGVtZW50LnNldEF0dHJpYnV0ZSgnbWluaScsICcnKVxyXG4gICAgICAgIGNvbnN0IHBhbmVsID0gYXRvbS53b3Jrc3BhY2UuYWRkTW9kYWxQYW5lbCh7XHJcbiAgICAgICAgICBpdGVtOiB0ZXh0RWRpdG9yRWxlbWVudCxcclxuICAgICAgICAgIHZpc2libGU6IHRydWUsXHJcbiAgICAgICAgfSlcclxuICAgICAgICB0ZXh0RWRpdG9yRWxlbWVudC5mb2N1cygpXHJcbiAgICAgICAgY29uc3QgZGlzcCA9IG5ldyBDb21wb3NpdGVEaXNwb3NhYmxlKClcclxuICAgICAgICBjb25zdCBjb250ID0gYXdhaXQgbmV3IFByb21pc2UoKHJlc29sdmUpID0+IHtcclxuICAgICAgICAgIGRpc3AuYWRkKFxyXG4gICAgICAgICAgICBhdG9tLmNvbW1hbmRzLmFkZCh0ZXh0RWRpdG9yRWxlbWVudCwge1xyXG4gICAgICAgICAgICAgICdjb3JlOmNvbmZpcm0nOiAoKSA9PiByZXNvbHZlKHRydWUpLFxyXG4gICAgICAgICAgICAgICdjb3JlOmNhbmNlbCc6ICgpID0+IHJlc29sdmUoZmFsc2UpLFxyXG4gICAgICAgICAgICB9KSxcclxuICAgICAgICAgIClcclxuICAgICAgICB9KVxyXG4gICAgICAgIGRpc3AuZGlzcG9zZSgpXHJcbiAgICAgICAgcGFuZWwuZGVzdHJveSgpXHJcbiAgICAgICAgaWYgKGNvbnQpIHtcclxuICAgICAgICAgIGNvbnN0IGNtZCA9IHRleHRFZGl0b3JFbGVtZW50LmdldE1vZGVsKCkuZ2V0VGV4dCgpXHJcbiAgICAgICAgICBjdXN0b21Db21tYW5kKGN1cnJlbnRUYXJnZXQuZ2V0TW9kZWwoKSwgY21kKS5jYXRjaCgoZSkgPT4ge1xyXG4gICAgICAgICAgICBjb25zb2xlLmVycm9yKGUpXHJcbiAgICAgICAgICB9KVxyXG4gICAgICAgIH1cclxuICAgICAgfSxcclxuICAgIH0pLFxyXG4gICAgYXRvbS53b3Jrc3BhY2Uub2JzZXJ2ZVRleHRFZGl0b3JzKChlZGl0b3IpID0+IHtcclxuICAgICAgY29uc3QgYnVmID0gZWRpdG9yLmdldEJ1ZmZlcigpXHJcbiAgICAgIGNvbnN0IGRpc3AgPSBuZXcgQ29tcG9zaXRlRGlzcG9zYWJsZSgpXHJcbiAgICAgIGRpc3AuYWRkKFxyXG4gICAgICAgIGJ1Zi5vbldpbGxTYXZlKGFzeW5jICgpID0+IHtcclxuICAgICAgICAgIGNvbnN0IHNob3VsZFJ1biA9IGF0b20uY29uZmlnLmdldCgndW5peC1maWx0ZXIucnVuT25TYXZlJywge1xyXG4gICAgICAgICAgICBzY29wZTogZWRpdG9yLmdldFJvb3RTY29wZURlc2NyaXB0b3IoKSxcclxuICAgICAgICAgIH0pXHJcbiAgICAgICAgICBpZiAoc2hvdWxkUnVuKSBhd2FpdCBydW4oZWRpdG9yKVxyXG4gICAgICAgIH0pLFxyXG4gICAgICAgIGJ1Zi5vbkRpZERlc3Ryb3koKCkgPT4ge1xyXG4gICAgICAgICAgc3Vicy5yZW1vdmUoZGlzcClcclxuICAgICAgICAgIGRpc3AuZGlzcG9zZSgpXHJcbiAgICAgICAgfSksXHJcbiAgICAgIClcclxuICAgICAgc3Vicy5hZGQoZGlzcClcclxuICAgIH0pLFxyXG4gIClcclxufVxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIGRlYWN0aXZhdGUoKSB7XHJcbiAgc3Vicy5kaXNwb3NlKClcclxufVxyXG5cclxuYXN5bmMgZnVuY3Rpb24gcnVuKGVkaXRvcjogVGV4dEVkaXRvcikge1xyXG4gIGNvbnN0IGNtZCA9IGF0b20uY29uZmlnLmdldCgndW5peC1maWx0ZXIuY29tbWFuZCcsIHtcclxuICAgIHNjb3BlOiBlZGl0b3IuZ2V0Um9vdFNjb3BlRGVzY3JpcHRvcigpLFxyXG4gIH0pXHJcbiAgcmV0dXJuIGN1c3RvbUNvbW1hbmQoZWRpdG9yLCBjbWQpXHJcbn1cclxuXHJcbmFzeW5jIGZ1bmN0aW9uIGN1c3RvbUNvbW1hbmQoZWRpdG9yOiBUZXh0RWRpdG9yLCBjbWQ6IHN0cmluZykge1xyXG4gIGNvbnN0IHRleHQgPSBlZGl0b3IuZ2V0VGV4dCgpXHJcbiAgcmV0dXJuIG5ldyBQcm9taXNlPHZvaWQ+KChyZXNvbHZlKSA9PiB7XHJcbiAgICBjb25zdCBuZXdFbnYgPSBPYmplY3QuYXNzaWduKHt9LCBwcm9jZXNzLmVudilcclxuICAgIG5ld0Vudi5GSUxFID0gZWRpdG9yLmdldFBhdGgoKVxyXG4gICAgY29uc3QgcHJvYyA9IENQLmV4ZWMoY21kLCB7IGVuY29kaW5nOiAndXRmOCcsIGVudjogbmV3RW52IH0sIChlcnJvciwgcmVzdWx0KSA9PiB7XHJcbiAgICAgIGlmIChlcnJvcikge1xyXG4gICAgICAgIGF0b20ubm90aWZpY2F0aW9ucy5hZGRFcnJvcihlcnJvci50b1N0cmluZygpLCB7XHJcbiAgICAgICAgICBkZXRhaWw6IGVycm9yLm1lc3NhZ2UsXHJcbiAgICAgICAgICBzdGFjazogZXJyb3Iuc3RhY2ssXHJcbiAgICAgICAgICBkaXNtaXNzYWJsZTogdHJ1ZSxcclxuICAgICAgICB9KVxyXG4gICAgICAgIHJlc29sdmUoKSAvLyBhbHdheXMgc2F2ZSB0aGUgZmlsZSFcclxuICAgICAgfSBlbHNlIHtcclxuICAgICAgICBjb25zdCBbZmlyc3QsIC4uLnBvaW50c10gPSBlZGl0b3JcclxuICAgICAgICAgIC5nZXRDdXJzb3JzKClcclxuICAgICAgICAgIC5tYXAoKGMpID0+IGMuZ2V0QnVmZmVyUG9zaXRpb24oKSlcclxuICAgICAgICBjb25zdCByZXBsYWNlVGV4dCA9IGF0b20uY29uZmlnLmdldCgndW5peC1maWx0ZXIucmVwbGFjZVRleHQnLCB7XHJcbiAgICAgICAgICBzY29wZTogZWRpdG9yLmdldFJvb3RTY29wZURlc2NyaXB0b3IoKSxcclxuICAgICAgICB9KVxyXG4gICAgICAgIGlmIChyZXBsYWNlVGV4dCkge1xyXG4gICAgICAgICAgZWRpdG9yLnNldFRleHQocmVzdWx0LnJlcGxhY2UoL14gKyQvZ20sICcnKSlcclxuICAgICAgICAgIGVkaXRvci5zZXRDdXJzb3JCdWZmZXJQb3NpdGlvbihmaXJzdClcclxuICAgICAgICAgIHBvaW50cy5mb3JFYWNoKChwKSA9PiBlZGl0b3IuYWRkQ3Vyc29yQXRCdWZmZXJQb3NpdGlvbihwKSlcclxuICAgICAgICB9XHJcbiAgICAgICAgcmVzb2x2ZSgpXHJcbiAgICAgIH1cclxuICAgIH0pXHJcbiAgICBwcm9jLnN0ZGluLndyaXRlKHRleHQpXHJcbiAgICBwcm9jLnN0ZGluLmVuZCgpXHJcbiAgfSlcclxufVxyXG4iXX0=